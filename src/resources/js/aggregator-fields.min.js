var tribe_ea=tribe_ea||{};tribe_ea.fields={selector:{container:".tribe-ea",form:".tribe-ea-form",help:".tribe-ea-help",fields:".tribe-ea-field",dropdown:".tribe-ea-dropdown",media_button:".tribe-ea-media_button",datepicker:".tribe-ea-datepicker",save_credentials_button:".enter-credentials .tribe-save",preview_container:".tribe-preview-container",preview_button:".tribe-preview:visible",refine_filters:".tribe-refine-filters",clear_filters_button:".tribe-clear-filters",finalize_button:".tribe-finalize"},media:{},$:{},construct:{},events:{},l10n:window.tribe_l10n_ea_fields,import_id:null,result_fetch_count:0,max_result_fetch_count:20,polling_frequency:500},function(e,t,r){"use strict";r.init=function(){r.$.container=e(r.selector.container),r.$.form=e(r.selector.form),r.$.fields=r.$.container.find(r.selector.fields),r.$.preview_container=e(r.selector.preview_container),e.each(r.construct,function(e,t){t(r.$.fields)}),e(document).on("keypress",r.selector.fields,r.events.trigger_field_change).on("click",r.selector.save_credentials_button,r.events.trigger_save_credentials).on("click",r.selector.clear_filters_button,r.clear_filters).on("click",r.selector.finalize_button,r.finalize_manual_import).on("click",".tribe-preview",r.preview_import).on("submit",".tribe-ea-tab-new",r.events.suppress_submission)},r.preview_import=function(){var t=e(r.selector.preview_button),a=t.closest("form"),i=a.serialize();r.$.preview_container.addClass("tribe-fetching").removeClass("tribe-fetch-error").removeClass("show-data"),t.prop("disabled",!0);var n=e(".dataTable").data("table");"undefined"!=typeof n&&n.clear().draw(),r.create_import(i)},r.reset_form=function(){r.$.fields.val("").trigger("change"),e(".tribe-ea-dropdown").select2("data",null),e('[id$="import_frequency"]').val("daily").trigger("change"),r.$.preview_container.removeClass("show-data")},r.clear_filters=function(){e(r.selector.refine_filters).find("input, select").val("").trigger("change")},r.create_import=function(t){var a=e.ajax({type:"POST",url:ajaxurl+"?action=tribe_create_import",data:t,dataType:"json"});a.done(function(t){return t.success?(r.import_id=t.data.data.import_id,e("#tribe-import_id").val(r.import_id),void setTimeout(r.poll_for_results,r.polling_frequency)):void r.display_fetch_error(["<b>",tribe_l10n_ea_fields.preview_fetch_error_prefix,"</b>"," "+t.data.message].join(" "))})},r.poll_for_results=function(){r.result_fetch_count++;var t=e.ajax({type:"GET",url:ajaxurl+"?action=tribe_fetch_import&import_id="+r.import_id,dataType:"json"});t.done(function(t){return t.success?void("success"!==t.data.status?r.result_fetch_count>r.max_result_fetch_count?r.display_fetch_error(["The preview is taking longer than expected. Please try again in a moment."].join("")):setTimeout(r.poll_for_results,r.polling_frequency):(r.init_datatable(t.data.data.events),r.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched"),e(r.selector.preview_button).prop("disabled",!1))):void r.display_fetch_error(["<b>",tribe_l10n_ea_fields.preview_fetch_error_prefix,"</b>"," "+t.data.message].join(" "))})},r.init_datatable=function(t){var a=!1,i=e('[id$="import_type"]:visible');i.length&&"manual"!==e("#"+i.first().attr("id").replace("s2id_","")).val()||(a=!0);var n=r.$.preview_container.find(".data-container table"),s=[];for(var o in t){var l=t[o];l.checkbox=a?'<input type="checkbox">':"",s.push(l)}a?n.addClass("display-checkboxes"):n.removeClass("display-checkboxes"),r.$.preview_container.addClass("show-data"),n.tribeDataTable({lengthMenu:[[5,10,25,50,-1],[5,10,25,50,tribe_l10n_datatables.pagination.all]],order:[[1,"asc"]],columnDefs:[{cellType:"th",className:"check-column",orderable:!1,targets:0}],columns:[{data:"checkbox"},{data:"start_date"},{data:"end_date"},{data:"title"}],data:s}),n.on("select.dt",r.events.twiddle_finalize_button_text).on("deselect.dt",r.events.twiddle_finalize_button_text);var c=tribe_l10n_ea_fields.import_all.replace("%d",s.length);e(r.selector.finalize_button).html(c)},r.display_fetch_error=function(t){r.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetch-error"),r.display_error(e(".tribe-fetch-error-message"),t),e(r.selector.preview_button).prop("disabled",!1)},r.display_error=function(e,t){e.prepend(['<div class="notice notice-error">',"<p>",t,"</p>","</div>"].join(""))},r.save_credentials=function(t){var r=e(this).closest(".tribe-fieldset").find("input").serialize(),a=ajaxurl+"?action=tribe_save_credentials&which=facebook",i=e.post(a,r);i.done(function(e){e.success&&(t.addClass("credentials-entered"),t.find("#tribe-has-credentials").val(1).change())})},r.finalize_manual_import=function(){var t=e(".dataTable"),a=t.data("table"),i=a.rows({selected:!0});if(i[0].length||(i=a.rows()),!i[0].length)return void r.display_error(e(".tribe-finalize-container"),tribe_l10n_ea_fields.events_required_for_manual_submit);var n=i.data(),s=[];for(var o in n)isNaN(o)||("undefined"!=typeof n[o].checkbox&&delete n[o].checkbox,s.push(n[o]));e("#tribe-selected-rows").text(JSON.stringify(s)),r.$.form.submit()},r.search_id=function(e){var t=null;return"undefined"!=typeof e.id?t=e.id:"undefined"!=typeof e.ID?t=e.ID:"undefined"!=typeof e.value&&(t=e.value),void 0==e?null:t},r.construct.dropdown=function(a){var i=a.filter(r.selector.dropdown).not(".select2-offscreen, .select2-container");return i.each(function(){var a=e(this),i={};if(a.is("select")||(i.id=r.search_id),i.allowClear=!0,a.data("preventClear")&&(i.allowClear=!1),a.is("[data-options]")&&(i.data=a.data("options")),a.is("[data-hide-search]")&&(i.minimumResultsForSearch=1/0),a.is("[multiple]")&&(i.multiple=!0,a.is("[data-tags]")||(i.data=function(){return{results:a.data("options")}}),t.isArray(a.data("separator"))?i.tokenSeparators=a.data("separator"):i.tokenSeparators=[a.data("separator")],i.separator=a.data("separator"),i.regexSeparatorElements=["^("],i.regexSplitElements=["(?:"],e.each(i.tokenSeparators,function(e,t){i.regexSeparatorElements.push("[^"+t+"]+"),i.regexSplitElements.push("["+t+"]")}),i.regexSeparatorElements.push(")$"),i.regexSplitElements.push(")"),i.regexSeparatorString=i.regexSeparatorElements.join(""),i.regexSplitString=i.regexSplitElements.join(""),i.regexToken=new RegExp(i.regexSeparatorString,"ig"),i.regexSplit=new RegExp(i.regexSplitString,"ig")),i.matcher=function(e,a){var n=0==a.toUpperCase().indexOf(e.toUpperCase());if(!n&&"undefined"!=typeof i.tags){var s=t.where(i.tags,{text:a});if(i.tags.length>0&&t.isObject(s)){var o=r.search_id(s[0]);n=0==o.toUpperCase().indexOf(e.toUpperCase())}}return n},a.is("[data-tags]")&&(i.tags=a.data("options"),i.initSelection=function(r,a){var n=[];e(r.val().split(i.regexSplit)).each(function(){var e={id:this,text:this};if(i.tags.length>0&&t.isObject(i.tags[0])){var r=t.where(i.tags,{value:this});r.length>0&&(e=r[0],e={id:e.value,text:e.text})}n.push(e)}),a(n)},i.createSearchChoice=function(e,t){return e.match(i.regexToken)?{id:e,text:e}:void 0},0===i.tags.length&&(i.formatNoMatches=function(){return a.attr("placeholder")})),a.is("[data-source]")){var n=a.data("source");i.data={results:[]},i.escapeMarkup=function(e){return e},i.ajax={dataType:"json",type:"POST",url:window.ajaxurl,results:function(e){return e.data}},i.ajax.data=function(e,t){return{action:"tribe_ea_dropdown_"+n}}}a.select2(i)}).on("change",function(r){var a=e(this),i=e(this).data("value");a.is("[multiple]")&&a.is("[data-source]")&&(r.added?t.isArray(i)?i.push(r.added):i=[r.added]:i=t.isArray(i)?t.without(i,r.removed):[],a.data("value",i).attr("data-value",JSON.stringify(i)))}),i},r.construct.media_button=function(t){var a=t.filter(r.selector.media_button);return"undefined"!=typeof wp&&wp.media&&wp.media.editor?(a.each(function(){var t=e(this),a=t.data("input"),i=e("#"+a),n=e("#"+a+"_name"),s=r.media[a]=wp.media({title:t.data("mediaTitle"),library:{type:t.data("mimeType")},multiple:!1});s.on("select",function(){var e=s.state(),t=e.get("selection");t&&t.each(function(e){i.data({id:e.attributes.id,text:e.attributes.title}),i.val(e.attributes.id),i.change(),n.html(e.attributes.title),n.attr("title",e.attributes.title)})}),s.on("open",function(){e(".media-router .media-menu-item").first().trigger("click")})}),r.$.container.on("click",r.selector.media_button,function(t){t.preventDefault();var a=e(this).data("input");return r.media[a].open(a),!1}),a):a},r.events.trigger_field_change=function(){e(this).change()},r.events.trigger_save_credentials=function(){r.save_credentials(e(this).closest(".enter-credentials"))},r.events.suppress_submission=function(t){return e("#tribe-selected-rows").val().length?!0:void t.preventDefault()},r.events.twiddle_finalize_button_text=function(t,a){var i=a.rows({selected:!0})[0].length,n=tribe_l10n_ea_fields.import_checked;i||(n=tribe_l10n_ea_fields.import_all,i=a.rows()[0].length),n=n.replace("%d",i),e(r.selector.finalize_button).html(n)},e(document).ready(r.init)}(jQuery,_,tribe_ea.fields);