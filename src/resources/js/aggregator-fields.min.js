var tribe_ea=tribe_ea||{};tribe_ea.fields={selector:{container:".tribe-ea",help:".tribe-ea-help",fields:".tribe-ea-field",dropdown:".tribe-ea-dropdown",media_button:".tribe-ea-media_button",datepicker:".tribe-ea-datepicker"},media:{},$:{},construct:{},l10n:window.tribe_l10n_ea_fields},function(e,t,a){"use strict";a.init=function(){a.$.container=e(a.selector.container),a.$.fields=a.$.container.find(a.selector.fields),e.each(a.construct,function(e,t){t(a.$.fields)}),e(document).on("keypress",a.selector.fields,function(){e(this).change()}),e(document).on("click",".enter-credentials .tribe-save",function(){var t=e(this).closest(".enter-credentials"),a=e(this).closest(".tribe-fieldset").find("input").serialize(),r=ajaxurl+"?action=tribe_save_credentials&which=facebook",i=e.post(r,a);i.done(function(e){e.success&&(t.addClass("credentials-entered"),t.find("#tribe-has-credentials").val(1).change())})}),e(document).on("submit",".tribe-ea-tab-new",function(e){e.preventDefault()}),e(document).on("click",".tribe-preview",function(t){var r=e(this),i=r.closest("form"),n=i.serialize(),s=e(".tribe-preview-container");s.addClass("tribe-fetching").removeClass("tribe-fetch-error"),r.prop("disabled",!0);var o=e.ajax({type:"POST",url:ajaxurl+"?action=tribe_create_import",data:n,dataType:"json"});o.done(function(t){return t.success?(a.import_id=t.data.data.import_id,void setTimeout(a.poll_for_results,300)):(s.removeClass("tribe-fetching").addClass("tribe-fetch-error"),e(".tribe-fetch-error-message").html(['<div class="notice notice-error">',"<p>","<b>",tribe_l10n_ea_fields.preview_fetch_error_prefix,"</b>"," "+t.data.message,"</p>","</div>"].join("")),void r.prop("disabled",!1))})})},a.poll_for_results=function(){var t=e.ajax({type:"GET",url:ajaxurl+"?action=tribe_fetch_import&import_id="+a.import_id,dataType:"json"});t.done(function(t){if(t.success)if("success"!==t.data.status)setTimeout(a.poll_for_results,300);else{var r=wp.template("preview"),i=t.data.data;i.display_checkboxes=!1;var n=e('[id$="import_type"]:visible');n.length&&"manual"!==e("#"+n.first().attr("id").replace("s2id_","")).val()||(i.display_checkboxes=!0),e(".tribe-ea-table-container").append(r(i)),e(".tribe-ea-table-container table").tribeDataTable({lengthMenu:[[5,10,25,50,-1],[5,10,25,50,tribe_l10n_datatables.pagination.all]],order:[[1,"asc"]],columnDefs:[{orderable:!1,targets:0}]});var s=e(".tribe-preview-container");s.removeClass("tribe-fetching").addClass("tribe-fetched")}})},a.search_id=function(e){var t=null;return"undefined"!=typeof e.id?t=e.id:"undefined"!=typeof e.ID?t=e.ID:"undefined"!=typeof e.value&&(t=e.value),void 0==e?null:t},a.construct.dropdown=function(r){var i=r.filter(a.selector.dropdown).not(".select2-offscreen, .select2-container");return i.each(function(){var r=e(this),i={};if(r.is("select")||(i.id=a.search_id),i.allowClear=!0,r.data("preventClear")&&(i.allowClear=!1),r.is("[data-options]")&&(i.data=r.data("options")),r.is("[data-hide-search]")&&(i.minimumResultsForSearch=1/0),r.is("[multiple]")&&(i.multiple=!0,r.is("[data-tags]")||(i.data=function(){return{results:r.data("options")}}),t.isArray(r.data("separator"))?i.tokenSeparators=r.data("separator"):i.tokenSeparators=[r.data("separator")],i.separator=r.data("separator"),i.regexSeparatorElements=["^("],i.regexSplitElements=["(?:"],e.each(i.tokenSeparators,function(e,t){i.regexSeparatorElements.push("[^"+t+"]+"),i.regexSplitElements.push("["+t+"]")}),i.regexSeparatorElements.push(")$"),i.regexSplitElements.push(")"),i.regexSeparatorString=i.regexSeparatorElements.join(""),i.regexSplitString=i.regexSplitElements.join(""),i.regexToken=new RegExp(i.regexSeparatorString,"ig"),i.regexSplit=new RegExp(i.regexSplitString,"ig")),i.matcher=function(e,r){var n=0==r.toUpperCase().indexOf(e.toUpperCase());if(!n&&"undefined"!=typeof i.tags){var s=t.where(i.tags,{text:r});if(i.tags.length>0&&t.isObject(s)){var o=a.search_id(s[0]);n=0==o.toUpperCase().indexOf(e.toUpperCase())}}return n},r.is("[data-tags]")&&(i.tags=r.data("options"),i.initSelection=function(a,r){var n=[];e(a.val().split(i.regexSplit)).each(function(){var e={id:this,text:this};if(i.tags.length>0&&t.isObject(i.tags[0])){var a=t.where(i.tags,{value:this});a.length>0&&(e=a[0],e={id:e.value,text:e.text})}n.push(e)}),r(n)},i.createSearchChoice=function(e,t){return e.match(i.regexToken)?{id:e,text:e}:void 0},0===i.tags.length&&(i.formatNoMatches=function(){return r.attr("placeholder")})),r.is("[data-source]")){var n=r.data("source");i.data={results:[]},i.escapeMarkup=function(e){return e},i.ajax={dataType:"json",type:"POST",url:window.ajaxurl,results:function(e){return e.data}},i.ajax.data=function(e,t){return{action:"tribe_ea_dropdown_"+n}}}r.select2(i)}).on("change",function(a){var r=e(this),i=e(this).data("value");r.is("[multiple]")&&r.is("[data-source]")&&(a.added?t.isArray(i)?i.push(a.added):i=[a.added]:i=t.isArray(i)?t.without(i,a.removed):[],r.data("value",i).attr("data-value",JSON.stringify(i)))}),i},a.construct.media_button=function(t){var r=t.filter(a.selector.media_button);return"undefined"!=typeof wp&&wp.media&&wp.media.editor?(r.each(function(){var t=e(this),r=t.data("input"),i=e("#"+r),n=e("#"+r+"_name"),s=a.media[r]=wp.media({title:t.data("mediaTitle"),library:{type:t.data("mimeType")},multiple:!1});s.on("select",function(){var e=s.state(),t=e.get("selection");t&&t.each(function(e){i.data({id:e.attributes.id,text:e.attributes.title}),i.val(e.attributes.id),i.change(),n.html(e.attributes.title),n.attr("title",e.attributes.title)})}),s.on("open",function(){e(".media-router .media-menu-item").first().trigger("click")})}),a.$.container.on("click",a.selector.media_button,function(t){t.preventDefault();var r=e(this).data("input");return a.media[r].open(r),!1}),r):r},e(document).ready(a.init)}(jQuery,_,tribe_ea.fields);